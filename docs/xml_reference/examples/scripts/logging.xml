<?xml version="1.0" encoding="UTF-8"?>

<!-- This example application shows the usage of scripts.

-->

<pitasc>

    <models>
        <include package="pitasc_library" file="models/pitasc.xml"/>
        <include package="pitasc_library" file="models/skills.xml"/>

        <include package="pitasc_library" file="universal_robots/ur.xml"/>
    </models>

    <clone prototype="project">

        <member id="configuration">
            <clone id="configuration" prototype="default_configuration"/>
        </member>

        <member id="environment">
            <clone prototype="robot_ur5">
                <member id="robot_driver.max_velocity">0.5</member>
                <member id="robot_driver.max_acceleration">2.0</member>
                <member id="components">
                    <clone prototype="force_sensor">
                        <member id="wrench_topic">wrench</member>
                    </clone>
                </member>
            </clone>
        </member>

        <member id="applications">
            <clone prototype="skill_sequence">

                <member id="robot" reference_id="environment.robot_ur5"/>

                <member id="skills">

                    <clone id="skill" prototype="skill_lin">
                        <member id="tool_frame">tool</member>
                        <member id="target_frame">start_position</member>

                        <member id="scripts">
                            <!-- log the pose control error -->
                            <clone prototype="script_error_logger">
                                <member id="controllers" reference_id="tasks.tracking.controllers"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %T}_error_lin.csv</member>
                            </clone>
                        </member>
                    </clone>

                    <clone prototype="skill_push_settle">
                        <member id="tool_frame">tool</member>
                        <member id="force_frame">start_position</member>
                        <member id="axes">z</member>
                        <member id="target_forces">30</member>
                        <member id="compliance">0.0005</member>
                        <member id="corner_frequency">7</member>

                        <member id="scripts">
                            <!-- log the force control error -->
                            <clone prototype="script_error_logger">
                                <member id="controllers" reference_id="force.tasks.apply_force.controllers"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}/{time %H_%M_%S}_error_push.csv</member>
                            </clone>
                        </member>
                    </clone>

                    <clone prototype="skill_lin">
                        <member id="tool_frame">tool</member>
                        <member id="target_frame">start_position</member>
                    </clone>

                    <clone prototype="skill_guarded_approach">
                        <member id="control_frame">start_position</member>
                        <member id="tool_frame">tool</member>
                        <member id="axes">z</member>
                        <member id="velocities">0.02</member>
                        <member id="max_forces">10.0</member>

                        <member id="scripts">
                            <!-- log the whole chain, means all forces and torques -->
                            <clone prototype="script_measurement_logger">
                                <member id="provider" reference_id="force_skill.collections.force_chain.chains"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_forceAndTorque_approach.csv</member>
                                <!-- filter is an optional argument. Can be omitted when you want to log the complete chain -->
                                <!-- <member id="filter">force_chain/x, force_chain/y, force_chain/z, force_chain/a, force_chain/b, force_chain/c</member> -->
                            </clone>

                            <!-- log the force in z-direction using a filter -->
                            <clone prototype="script_measurement_logger">
                                <member id="provider" reference_id="force_skill.collections.force_chain.chains"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_z_force_approach.csv</member>
                                <member id="filter">force_chain/z</member>
                            </clone>

                            <!-- log xy target to tool position and z rotation using a filter -->
                            <clone prototype="script_measurement_logger">
                                <member id="provider" reference_id="move_skill.collections.target_to_tool.chains"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_position_xy_approach.csv</member>
                                <member id="filter">target_to_tool/x, target_to_tool/y, target_to_tool/c</member>
                            </clone>

                            <!-- log z target to tool position with simple filter keys -->
                            <clone prototype="script_measurement_logger">
                                <member id="provider" reference_id="move_skill.collections.target_to_tool.chains"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_position_z_approach.csv</member>
                                <member id="use_simple_filter_keys">True</member>  <!-- allows to specify the filter without the chain... -->
                                <member id="filter">z</member>  <!-- ...then you dont need to specify the chain here. Also works for force chains -->
                            </clone>
                        </member>
                    </clone>

                    <clone prototype="skill_lin">
                        <member id="tool_frame">tool</member>
                        <member id="target_frame">target1</member>
                        <member id="scripts">
                            <!-- log the desired position (setpoint) with simple filter keys -->
                            <clone prototype="script_measurement_logger">
                                <member id="provider" reference_id="tasks.tracking.setpoint_generators"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_skill_lin_setpoint.csv</member>
                                <member id="use_simple_filter_keys">True</member>  <!-- allows to specify the filter without the chain... -->
                                <member id="filter">x,y,z</member>  <!-- ...then you dont need to specify the chain here. Also works for force chains -->
                            </clone>
                            <!-- log the current position with simple filter keys -->
                            <clone prototype="script_measurement_logger">
                                <member id="provider" reference_id="collections.target_to_tool.chains"/>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_skill_lin_current_position.csv</member>
                                <member id="use_simple_filter_keys">True</member>  <!-- allows to specify the filter without the chain... -->
                                <member id="filter">x,y,z</member>  <!-- ...then you dont need to specify the chain here. Also works for force chains -->
                            </clone>
                            <!-- log the desired (setpoint) and current position in the same file -->
                            <clone prototype="script_measurement_logger">
                                <member id="provider">
                                    <reference reference_id="tasks.tracking.setpoint_generators.setpoint" />
                                    <reference reference_id="collections.target_to_tool.chains[0]" />
                                </member>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_skill_lin_setpoint_and_current_position.csv</member>
                                <member id="use_simple_filter_keys">True</member>  <!-- allows to specify the filter without the chain... -->
                                <member id="filter">x,y,z</member>  <!-- ...then you dont need to specify the chain here. Also works for force chains -->
                            </clone>
                        </member>
                    </clone>

                    <!-- log position, rotation and/or force during a skill_sequence -->
                    <!-- use logging skills concurrent to the actual skills -->
                    <clone prototype="skill_concurrency">
                        <member id="skills">
                            <!-- log tool pose (position and rotation) in base_link coordinates -->
                            <clone prototype="skill_log_cartesian">
                                <member id="measured_frame">tool</member>
                                <member id="reference_frame">base_link</member>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_pose_tool_to_base.csv</member>
                                <!-- filter is an optional argument. Can be omitted when you want to log the complete chain -->
                                <!-- <member id="filter">x, y, z, a, b, c</member> -->
                            </clone>

                            <!-- log tool yz position in base_link coordinates using a filter-->
                            <clone prototype="skill_log_cartesian">
                                <member id="measured_frame">tool</member>
                                <member id="reference_frame">base_link</member>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_yz_position_tool_to_base.csv</member>
                                <member id="filter">y,z</member>  <!-- (in logging *skills* you dont need to specify the chain) -->
                            </clone>

                            <!-- log tool rotation in base_link coordinates using a filter-->
                            <clone prototype="skill_log_cartesian">
                                <member id="measured_frame">tool</member>
                                <member id="reference_frame">base_link</member>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_rotation_tool_to_base.csv</member>
                                <member id="filter">a,b,c</member>  <!-- (in logging *skills* you dont need to specify the chain) -->
                            </clone>

                            <!-- log force at tool frame in tool coordinates, using a filter-->
                            <clone prototype="skill_log_force">
                                <member id="force_frame">tool</member>
                                <member id="file_name">{rospkg pitasc_common}/examples/scripts/logs/{time %F}_force_tool.csv</member>
                                <member id="filter">x,y,z</member>  <!-- (in logging *skills* you dont need to specify the chain) -->
                            </clone>

                            <!-- the actual robot skills, running concurrently to the logging skills -->
                            <clone prototype="skill_sequence">
                                <member id="skills">
                                    <clone prototype="skill_lin">
                                        <member id="tool_frame">tool</member>
                                        <member id="target_frame">start_position</member>
                                    </clone>

                                    <clone prototype="skill_push_settle">
                                        <member id="tool_frame">tool</member>
                                        <member id="force_frame">start_position</member>
                                        <member id="axes">z</member>
                                        <member id="target_forces">30</member>
                                        <member id="compliance">0.0005</member>
                                        <member id="corner_frequency">7</member>
                                    </clone>
                                </member>
                            </clone>
                        </member>
                    </clone>

                    <!-- publish measurements to a ros topic-->
                    <clone prototype="skill_lin">
                        <member id="tool_frame">tool</member>
                        <member id="target_frame">target1</member>
                        <member id="scripts">
                            <!-- publish measurements to a ros topic-->
                            <clone prototype="script_measurement_publisher">
                                <member id="provider" reference_id="collections.target_to_tool.chains[0]"/>
                                <member id="topic">tool_position</member>
                                <member id="coordinates">x,y,z</member>
                            </clone>
                        </member>
                    </clone>

                </member>
            </clone>
        </member>

    </clone>

</pitasc>
