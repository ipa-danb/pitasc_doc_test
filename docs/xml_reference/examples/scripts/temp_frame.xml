<?xml version="1.0" encoding="UTF-8"?>

<!-- This example application shows the usage of the script_temp_frame_from_force. This is helpful for example when you do not know the orientation of a surface, but want to appply forces perpendicular to it.
-->

<pitasc>

    <models>
        <include package="pitasc_library" file="models/pitasc.xml"/>
        <include package="pitasc_library" file="models/skills.xml"/>

        <include package="pitasc_library" file="universal_robots/ur.xml"/>
    </models>

    <clone prototype="project">

        <member id="configuration">
            <clone id="configuration" prototype="default_configuration"/>
        </member>

        <member id="environment">
            <clone prototype="robot_ur5">
                <member id="robot_driver.max_velocity">2.0</member>
                <member id="robot_driver.max_acceleration">3.0</member>
                <member id="components">
                    <clone prototype="force_sensor">
                        <member id="wrench_topic">wrench</member>
                    </clone>
                </member>
            </clone>
        </member>

        <member id="applications">
            <clone prototype="skill_sequence">

                <member id="robot" reference_id="environment.robot_ur5"/>

                <!-- Skills -->
                <member id="skills">


                    <clone prototype="skill_lin">
                        <member id="tool_frame">tool</member>
                        <member id="target_frame">start_position</member>
                        <member id="target_offsets">0,0,0,0.7,0,0</member>
                    </clone>

                    <!-- Pushes in z direction to get contact to the surface -->
                    <clone id="force_skill" prototype="skill_push">
                        <member id="tool_frame">tool</member>
                        <member id="force_frame">tool</member>
                        <member id="axes">z</member>
                        <member id="target_forces">10</member>
                        <member id="compliance">0.001</member>
                        <member id="corner_frequency">7</member>
                        <member id="monitors">
                            <clone id="force_out_threshold" prototype="monitor_threshold">
                                <member id="provider" reference_id="force.collections.force_chain.chains[0]"/>
                                <member id="coordinates">x,y,z</member>
                                <member id="prefix" reference_id="force.collections.force_chain.prefix"/>
                                <member id="operator">absolute_greater</member>
                                <member id="thresholds">10</member>                                <!-- TODO Parameter?-->
                                <member id="multi_coordinates_handling">vector_norm</member>
                            </clone>
                        </member>
                    </clone>

                    <!-- Pushes in the direction of the measured force -->
                    <clone prototype="skill_push">
                        <member id="tool_frame">tool</member>
                        <member id="force_frame">force_oriented_tool_frame</member>
                        <member id="axes">z</member>
                        <member id="target_forces">50</member>
                        <member id="compliance">0.001</member>
                        <member id="corner_frequency">7</member>
                        <member id="scripts">
                            <clone prototype="script_temp_frame_from_force">
                                <member id="frame">force_oriented_tool_frame</member>
                                <member id="source">tool</member>
                                <member id="parent" reference_id="robot.base_link"/>
                                <member id="low_pass_filter_gain">0.01</member>
                                <member id="tf_broadcast">true</member>
                            </clone>
                        </member>
                        <member id="monitors">
                            <clone id="force_out_threshold" prototype="monitor_threshold">
                                <member id="provider" reference_id="force.collections.force_chain.chains[0]"/>
                                <member id="coordinates">x,y,z</member>
                                <member id="prefix" reference_id="force.collections.force_chain.prefix"/>
                                <member id="operator">absolute_greater</member>
                                <member id="thresholds">40</member>
                                <member id="multi_coordinates_handling">vector_norm</member>
                            </clone>


                        </member>
                    </clone>

                    <!-- Moves in the direction of the previously calculated measured force frame.
                         This frame still exists if it hasn't been invalidated at the end of the script. -->
                    <clone prototype="skill_guarded_slide">
                        <member id="tool_frame">tool</member>
                        <member id="control_frame">force_oriented_tool_frame</member>

                        <!-- moving -->
                        <member id="move_axes">y</member>
                        <member id="velocities">0.02</member>

                        <!-- pushing -->
                        <member id="force_axes">z</member>
                        <member id="target_forces">5.0</member>

                        <member id="max_forces">10</member>

                        <!-- transition -->
                        <member id="monitors">
                            <clone prototype="monitor_duration">
                                <member id="duration">2.0</member>
                            </clone>
                        </member>
                    </clone>


                    <clone prototype="skill_lin">
                        <member id="tool_frame">tool</member>
                        <member id="target_frame">target1</member>
                    </clone>

                    <!-- track a sinus modulated frame -->
                    <clone prototype="skill_concurrency">
                        <member id="skills">
                            <clone prototype="skill_cartesian_tracking">
                                <member id="tool_frame">tool</member>
                                <member id="target_frame">my_sinus_frame</member>
                                <member id="linear_controller_gain">7</member>
                                <member id="monitors">
                                    <clone prototype="monitor_duration">
                                        <member id="duration">6.0</member>
                                    </clone>
                                </member>
                            </clone>
                        </member>

                        <member id="scripts">
                            <clone prototype="script_sinus_frame">
                                <member id="frame">my_sinus_frame</member> <!-- name of the sinus modulated frame -->
                                <member id="source">target1</member> <!-- which frame should be taken -->
                                <member id="parent">base_link</member> <!-- where to hang frame on -->
                                <member id="amplitude">0.02</member>
                                <member id="period">4</member>
                                <member id="coordinate">y</member> <!-- which coordinate should be modulated -->
                                <member id="tf_broadcast">true</member>
                            </clone>
                        </member>
                    </clone>

                </member>

            </clone>
        </member>

    </clone>

</pitasc>
