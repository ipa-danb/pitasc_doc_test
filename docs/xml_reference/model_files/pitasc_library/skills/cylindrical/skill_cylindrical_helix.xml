<?xml version="1.0" encoding="UTF-8"?>

<pitasc>

    <models>
        <include package="pitasc_library" file="models/pitasc.xml"/>

        <include package="pitasc_library" file="skills/cylindrical/skill_cylindrical_velocity.xml"/>
        <include package="pitasc_library" file="skills/cylindrical/skill_cylindrical_tracking.xml"/>

        <type id="skill_cylindrical_helix" prototype="skill_sequence">
            <meta>
                <member id="description">A skill that performs a cylindrical helix around z axis of the specified pivot_frame</member>
                <member id="categories">single_robot, velocity_controlled</member>
            </meta>

            <data>
                <type id="tool_frame" prototype="string_parameter">
                    <meta>
                        <member id="description">
                            The used tool frame.
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>tool</data>
                </type>

                <type id="pivot_frame" prototype="string_parameter">
                    <meta>
                        <member id="description">
                            The pivot point (i.e. tip of the cone).
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>pivot_point</data>
                </type>

                <type id="radius" prototype="float_parameter">
                    <meta>
                        <member id="description">
                            Distance from the desired start point to the origin of pivot_frame [m].
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0.05</data>
                </type>

                 <type id="height" prototype="float_csv">
                    <meta>
                        <member id="description">
                            Distance from the desired end point to the origin of pivot_frame [m]. Only one value allowed.
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0.2</data>
                </type>

                <type id="start_phi" prototype="float_parameter">
                    <meta>
                        <member id="description">
                            Initial value of angle phi (in x-y-plane of pivot_frame) [rad].
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0</data>
                </type>


                <type id="helix_linear_velocity" prototype="float_parameter">
                    <meta>
                        <member id="description">
                            The speed of the motion in radial direction
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0.005</data>
                </type>

                <type id="helix_angular_velocity" prototype="float_parameter">
                    <meta>
                        <member id="description">
                            The speed of the rotation movement.
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0.5</data>
                </type>

                <type id="tool_direction" data_type="list:float_parameter" prototype="base">
                    <meta>
                        <member id="description">
                            The rpy tool orientation (a,b,c) in [rad]
                        </member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>
                      <clone id="a" prototype="float_parameter">0</clone>
                      <clone id="b" prototype="float_parameter">0</clone>
                      <clone id="c" prototype="float_parameter">0</clone>
                    </data>
                </type>

                <!-- Implementation details below: -->

                <type id="des_velocities" data_type="list:float_parameter" prototype="base">
                    <meta>
                        <member id="description">Defines the helix velocities</member>
                        <member id="visibility">hidden</member>
                    </meta>
                    <data>
                        <reference reference_id="helix_angular_velocity" />
                        <reference reference_id="helix_linear_velocity" />
                    </data>
                </type>

                <type id="start_offsets" data_type="list:float_parameter" prototype="base">
                    <meta>
                        <member id="description">Defines the helix - r, phi, z, a, b, c</member>
                        <member id="visibility">hidden</member>
                    </meta>
                    <data>
                        <reference reference_id="radius" />
                        <reference reference_id="start_phi" />
                        <clone prototype="float_parameter">0</clone>
                        <reference reference_id="tool_direction.a" />
                        <reference reference_id="tool_direction.b" />
                        <reference reference_id="tool_direction.c" />
                    </data>
                </type>

                <type id="constant_offsets" data_type="list:float_parameter" prototype="base">
                    <meta>
                        <member id="description">Defines the helix - constant offsets (r, a, b, c)</member>
                        <member id="visibility">hidden</member>
                    </meta>
                    <data>
                        <reference reference_id="radius" />
                        <reference reference_id="tool_direction.a" />
                        <reference reference_id="tool_direction.b" />
                        <reference reference_id="tool_direction.c" />
                    </data>
                </type>

                <!-- Add skills -->
                <member id="skills">

                  <!-- move to start position -->
                  <clone prototype="skill_cylindrical_positioning">
                      <member id="tool_frame" reference_id="tool_frame" />
                      <member id="target_frame" reference_id="pivot_frame" />
                      <member id="target_offsets" reference_id="start_offsets" />
                      <!-- r, phi, z, a, b, c-->
                  </clone>

                    <clone prototype="skill_concurrency">
                        <member id="skills">
                            <clone prototype="skill_cylindrical_velocity">
                                <member id="tool_frame" reference_id="tool_frame" />"
                                <member id="target_frame" reference_id="pivot_frame" />
                                <member id="axes">phi, z</member>
                                <member id="velocities" reference_id="des_velocities" />
                                <member id="monitors">
                                    <clone prototype="monitor_threshold">
                                        <member id="provider" reference_id="collections.target_to_tool.chains[0]"/>
                                        <member id="coordinates">z</member>
                                        <member id="prefix" reference_id="collections.target_to_tool.prefix"/>
                                        <member id="operator">absolute_greater</member>
                                        <member id="thresholds" reference_id="height"/>
                                    </clone>
                                </member>
                            </clone>
                            <clone id="hold" prototype="skill_cylindrical_tracking">
                                <member id="tool_frame" reference_id="tool_frame" />
                                <member id="target_frame" reference_id="pivot_frame" />
                                <member id="axes">r, a, b, c</member>
                                <member id="target_offsets" reference_id="constant_offsets" />
                            </clone>
                        </member>
                    </clone>

                </member>
                <member id="skills.meta.visibility">expert</member>

            </data>
        </type>
    </models>
</pitasc>
