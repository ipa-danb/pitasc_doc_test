<?xml version="1.0" encoding="UTF-8"?>

<pitasc>

    <models>
        <include package="pitasc_library" file="skills/skill_joint_space.xml"/>

        <type id="skill_ptp_time_optimal" prototype="skill_joint_space">
            <meta>
                <member id="description">Keeps on tracking a joint configuration using a time-optimal trajectory</member>
            </meta>

            <data>

                <!-- Task description -->
                <type id="joint_names" prototype="string_csv">
                    <meta>
                        <member id="description">Joint names of the target pose.</member>
                        <member id="visibility">basic</member>
                    </meta>
                </type>
                <member id="joint_names" reference_id="robot.joint_names"/>

                <type id="target_joint_state" prototype="float_csv">
                    <meta>
                        <member id="description">Joint values of the target pose.</member>
                        <member id="visibility">required</member>
                    </meta>
                </type>

                <type id="trajectory_duration" prototype="float_parameter">
                    <meta>
                        <member id="description">Duration of the trajectory in [s]; '0' means as fast as possible. The realized duration can be longer if the original value conflicts with maximal velocity.</member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0</data>
                </type>

                <!-- Control -->
                <type id="max_angular_velocity" prototype="float_parameter">
                    <meta>
                        <member id="description">Max angular velocity.</member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>1.0</data>
                </type>
                <type id="max_angular_acceleration" prototype="float_parameter">
                    <meta>
                        <member id="description">Max angular acceleration.</member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>1.0</data>
                </type>
                <type id="angular_controller_gain" prototype="float_parameter">
                    <meta>
                        <member id="description">
                            Specifies the angular controller gain for joint position control.
                        </member>
                        <member id="visibility">expert</member>
                    </meta>
                    <data>3.0</data>
                </type>
                <type id="angular_ff_controller_gain" prototype="float_parameter">
                    <meta>
                        <member id="description">
                            Specifies the angular velocity-feed-forward controller gain for joint position control.
                        </member>
                        <member id="visibility">expert</member>
                    </meta>
                    <data>0.7</data>
                </type>

                <type id="joint_positioning_accuracy" prototype="float_csv">
                    <meta>
                        <member id="description">Threshold around the target joint state to consider it reached by the robot. One entry for all OR one entry for each joint.</member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0.01</data>
                </type>

                <type id="positioning_monitor" prototype="monitor_ptp_distance">
                    <meta>
                        <member id="description">Checks whether the target joint state has been reached</member>
                        <member id="visibility">expert</member>
                    </meta>
                    <data>
                        <member id="robot_driver" reference_id="robot.robot_driver"/>
                        <member id="coordinates" reference_id="tasks.tracking.coordinates"/>
                        <member id="distances" reference_id="joint_positioning_accuracy"/>
                        <member id="target_joint_states" reference_id="target_joint_state" />
                        <member id="operator">absolute_less_equal</member>
                    </data>
                </type>

                <member id="monitors">
                    <reference reference_id="positioning_monitor"/>
                </member>

                <!-- Implementation details below: -->

                <member id="tasks">
                    <clone id="tracking" prototype="task">
                        <member id="coordinates" reference_id="joint_names"/><!-- already prefixed -->

                        <member id="setpoint_generators">
                            <clone id="setpoint" prototype="time_optimal_setpoint">
                                <member id="data_source">
                                    <reference prototype="robot_driver" reference_id="robot.robot_driver"/>
                                </member>
                                <member id="desired" reference_id="target_joint_state"/>
                                <member id="coordinates" reference_id="coordinates"/>
                                <member id="prefix" reference_id="prefix"/>
                                <member id="duration" reference_id="trajectory_duration"/>
                                <member id="max_vel_groups">
                                    <reference reference_id="max_angular_velocity"/>
                                </member>
                                <member id="max_acc_groups">
                                    <reference reference_id="max_angular_acceleration"/>
                                </member>
                                <clone id="joints_as_groups" prototype="string_csv_disassembled_as_csv_list">
                                    <reference reference_id="joint_names" />
                                </clone>
                                <member id="symbol_groups" reference_id="joints_as_groups" />
                            </clone>
                        </member>

                        <member id="controllers">
                            <clone prototype="trajectory_p_controller">
                                <member id="gain" reference_id="angular_controller_gain"/>
                                <member id="limit" reference_id="max_angular_velocity"/>
                                <member id="ff_gain" reference_id="angular_ff_controller_gain"/>
                                <member id="data_source">
                                    <reference prototype="robot_driver" reference_id="robot.robot_driver"/>
                                </member>
                                <member id="setpoint_generator">
                                    <reference reference_id="setpoint_generators.setpoint"/>
                                </member>
                                <member id="coordinates" reference_id="coordinates"/>
                                <member id="prefix" reference_id="prefix"/>
                            </clone>
                        </member>
                    </clone>
                </member>
                <member id="tasks.meta.visibility">hidden</member>

            </data>
        </type>

    </models>

</pitasc>
