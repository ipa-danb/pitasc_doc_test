<?xml version="1.0" encoding="UTF-8"?>

<pitasc>

    <models>
        <include package="pitasc_library" file="models/pitasc.xml"/>
        <include package="pitasc_library" file="skills/spherical/skill_spherical.xml"/>

        <type id="skill_spherical_tracking" prototype="skill_spherical">
            <meta>
                <member id="description">Spherical coordinates</member>
                <member id="categories">single_robot, position_controlled</member>
            </meta>
            <data>
                <!-- When no rotations for a, b, c are given, the x-axis will point away from the target's z-axis -->
                <type id="axes" prototype="string_csv">
                    <meta>
                        <member id="description">List of axes to be aligned</member>
                        <member id="visibility">basic</member>
                        <clone prototype="restrictions">
                            <clone prototype="enum">phi, theta, r, a, b, c</clone>
                        </clone>
                    </meta>
                    <data>phi, theta, r, a, b, c</data>
                </type>
                <type id="target_offsets" prototype="float_csv">
                    <meta>
                        <member id="description">Offsets of the axes to be aligned. Must be the same number of values as for 'axes'.</member>
                        <member id="visibility">basic</member>
                        <clone prototype="restrictions">
                            <clone prototype="float_csv_min">-3.14, -3.14, -10.0, -3.14, -3.14, -3.14</clone>
                            <clone prototype="float_csv_max">3.14, 3.14, 10.0, 3.14, 3.14, 3.14</clone>
                        </clone>
                    </meta>
                    <data>0, 0, 0, 0, 0, 0</data>
                </type>

                <!-- Control -->
                <type id="max_linear_velocity" prototype="float_parameter">
                    <meta>
                        <member id="description">Max linear velocity.</member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>0.5</data>
                </type>
                <type id="max_angular_velocity" prototype="float_parameter">
                    <meta>
                        <member id="description">Max angular velocity.</member>
                        <member id="visibility">basic</member>
                    </meta>
                    <data>2.0</data>
                </type>
                <type id="linear_controller_gain" prototype="float_parameter">
                    <meta>
                        <member id="description">Equivalent proportional controller in linear region.</member>
                        <member id="visibility">expert</member>
                    </meta>
                    <data>1.0</data>
                </type>
                <type id="angular_controller_gain" prototype="float_parameter">
                    <meta>
                        <member id="description">Equivalent proportional controller in linear region.</member>
                        <member id="visibility">expert</member>
                    </meta>
                    <data>3.0</data>
                </type>

                <!-- Implementation details below: -->

                <member id="tasks">
                    <clone id="tracking" prototype="task">
                        <member id="coordinates" reference_id="axes"/>
                        <member id="prefix" reference_id="collections.target_to_tool.prefix"/>

                        <member id="setpoint_generators">
                            <clone id="setpoint" prototype="constant_setpoint">
                                <member id="desired" reference_id="target_offsets"/>
                                <member id="coordinates" reference_id="coordinates"/>
                                <member id="prefix" reference_id="prefix"/>
                            </clone>
                        </member>

                        <member id="controllers">
                            <!-- position controller -->
                            <clone id="position_controller" prototype="tanh_controller">
                                <member id="max_output" reference_id="max_linear_velocity"/>
                                <member id="P_lin" reference_id="linear_controller_gain"/>
                                <member id="data_source">
                                    <reference reference_id="collections.target_to_tool.chains[0]"/>
                                </member>
                                <member id="setpoint_generator">
                                    <reference reference_id="setpoint_generators.setpoint"/>
                                </member>
                                <member id="coordinates">r</member>
                                <member id="prefix" reference_id="prefix"/>
                            </clone>

                            <!-- orientation controller -->
                            <clone id="orientation_controller" prototype="tanh_controller">
                                <member id="max_output" reference_id="max_angular_velocity"/>
                                <member id="P_lin" reference_id="angular_controller_gain"/>
                                <member id="data_source">
                                    <reference reference_id="collections.target_to_tool.chains[0]"/>
                                </member>
                                <member id="setpoint_generator">
                                    <reference reference_id="setpoint_generators.setpoint"/>
                                </member>
                                <member id="coordinates">theta, phi, a, b, c</member>
                                <member id="prefix" reference_id="prefix"/>
                            </clone>
                        </member>
                    </clone>
                </member>
                <member id="tasks.meta.visibility">hidden</member>

            </data>
        </type>

        <type id="skill_spherical_positioning" prototype="skill_spherical_tracking">
            <meta>
                <member id="description">Spherical coordinates</member>
                <member id="categories">single_robot, position_controlled</member>
            </meta>
            <data>
                <!-- Coordination -->
                <type id="positioning_monitor" prototype="monitor_control_error">
                    <meta>
                        <member id="description">Checks whether the target frame has been reached.</member>
                        <member id="visibility">expert</member>
                    </meta>
                    <data>
                        <member id="controllers" reference_id="tasks.tracking.controllers"/>
                        <member id="coordinates" reference_id="axes"/>
                        <member id="prefix" reference_id="collections.target_to_tool.prefix"/>
                        <member id="thresholds"> 0.005, 0.005, 0.001, 0.005, 0.005, 0.005</member>
                    </data>
                </type>
                <member id="monitors">
                    <reference reference_id="positioning_monitor"/>
                </member>
            </data>
        </type>

    </models>

</pitasc>
